<div class="min-h-screen p-4 sm:p-8">
  <!-- Header -->
  <header class="max-w-7xl mx-auto mb-8 animate-fade-in">
    <div class="glass-effect rounded-3xl p-6 glow-effect">
      <div class="flex items-center justify-between flex-wrap gap-4">
        <div class="flex items-center gap-4">
          <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-grok-purple to-grok-pink flex items-center justify-center text-3xl font-bold shadow-lg">
            🐕
          </div>
          <div>
            <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-400 via-pink-400 to-blue-400 bg-clip-text text-transparent">
              Grok Chat
            </h1>
            <p class="text-gray-400 text-sm">Powered by grok-4-fast-reasoning</p>
          </div>
        </div>
        
        <div class="flex gap-2 flex-wrap">
          <button
            (click)="showSystemPrompt = !showSystemPrompt"
            class="px-4 py-2 rounded-xl glass-effect hover:bg-white/10 transition-all duration-300 text-sm font-medium"
            [class.bg-grok-purple/30]="showSystemPrompt"
          >
            ⚙️ System Prompt
          </button>
          
          <button
            (click)="toggleComparisonMode()"
            class="px-4 py-2 rounded-xl glass-effect hover:bg-white/10 transition-all duration-300 text-sm font-medium"
            [class.bg-grok-blue/30]="comparisonMode"
          >
            🔀 A/B Test
          </button>
          
          <button
            (click)="saveConversation()"
            class="px-4 py-2 rounded-xl glass-effect hover:bg-white/10 transition-all duration-300 text-sm font-medium"
            [disabled]="messages.length === 0"
          >
            💾 Save
          </button>
          
          <button
            (click)="exportConversation()"
            class="px-4 py-2 rounded-xl glass-effect hover:bg-white/10 transition-all duration-300 text-sm font-medium"
            [disabled]="messages.length === 0"
          >
            📥 Export
          </button>
          
          <button
            (click)="clearChat()"
            class="px-4 py-2 rounded-xl glass-effect hover:bg-red-500/20 transition-all duration-300 text-sm font-medium"
          >
            🗑️ Clear
          </button>
        </div>
      </div>
      
      <!-- Status Indicator -->
      <div class="mt-4 flex items-center gap-2">
        <div 
          class="w-3 h-3 rounded-full animate-pulse"
          [class.bg-green-400]="apiKeyConfigured"
          [class.bg-red-400]="!apiKeyConfigured"
        ></div>
        <span class="text-sm" [class.text-green-400]="apiKeyConfigured" [class.text-red-400]="!apiKeyConfigured">
          {{ apiKeyConfigured ? 'Connected' : 'Not Connected' }}
        </span>
      </div>
    </div>
  </header>

  <!-- Error Display -->
  <div *ngIf="error" class="max-w-7xl mx-auto mb-4 animate-slide-in">
    <div class="bg-red-500/10 border border-red-500/30 rounded-2xl p-4 backdrop-blur-xl">
      <div class="flex items-start gap-3">
        <span class="text-2xl">⚠️</span>
        <div class="flex-1">
          <h3 class="font-semibold text-red-400">Error</h3>
          <p class="text-red-300 text-sm mt-1">{{ error }}</p>
        </div>
        <button (click)="error = ''" class="text-red-400 hover:text-red-300">✕</button>
      </div>
    </div>
  </div>

  <!-- System Prompt Editor -->
  <div *ngIf="showSystemPrompt" class="max-w-7xl mx-auto mb-8 animate-slide-in">
    <div class="glass-effect rounded-2xl p-6 border-2 border-grok-purple/30">
      <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
        <span>🎭</span> System Prompt
      </h2>
      <textarea
        [(ngModel)]="systemPrompt"
        class="w-full bg-black/30 rounded-xl p-4 min-h-[120px] border border-white/10 focus:border-grok-purple focus:outline-none resize-none"
        placeholder="Define Grok's personality and behavior..."
      ></textarea>
      <div class="mt-4 flex items-center gap-4">
        <label class="flex items-center gap-2 text-sm">
          <span>Temperature:</span>
          <input
            type="range"
            [(ngModel)]="temperature"
            min="0"
            max="2"
            step="0.1"
            class="w-32"
          />
          <span class="font-mono bg-black/30 px-2 py-1 rounded">{{ temperature }}</span>
        </label>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto">
    <!-- Main Content -->
    <div class="grid gap-4" [class.lg:grid-cols-2]="comparisonMode && comparisonBranches.length > 0">
      
      <!-- Regular Chat or First Comparison -->
      <div class="glass-effect rounded-3xl overflow-hidden flex flex-col" [style.height.px]="600">
        
        <!-- Messages Container -->
        <div class="flex-1 overflow-y-auto p-6 space-y-4 scrollbar-thin scrollbar-thumb-purple-500/50 scrollbar-track-transparent">
          
          <div *ngFor="let message of comparisonMode && comparisonBranches.length > 0 ? comparisonBranches[0].messages : messages" 
               class="animate-slide-in"
               [class.flex]="message.role !== 'system'"
               [class.justify-end]="message.role === 'user'">
            
            <div *ngIf="message.role === 'user'" class="max-w-[80%]">
              <div class="bg-gradient-to-r from-grok-purple to-grok-pink rounded-2xl rounded-tr-sm p-4 shadow-lg">
                <p class="text-white whitespace-pre-wrap">{{ message.content }}</p>
                <span class="text-xs text-white/60 mt-2 block">{{ message.timestamp | date:'short' }}</span>
              </div>
            </div>
            
            <div *ngIf="message.role === 'assistant'" class="max-w-[80%]">
              <div class="bg-white/5 border border-white/10 rounded-2xl rounded-tl-sm p-4 shadow-lg backdrop-blur-sm">
                <p class="text-gray-100 whitespace-pre-wrap">{{ message.content }}</p>
                <span class="text-xs text-gray-500 mt-2 block">{{ message.timestamp | date:'short' }}</span>
              </div>
            </div>
          </div>
          
          <div *ngIf="isLoading && !comparisonMode" class="flex justify-start animate-pulse">
            <div class="bg-white/5 border border-white/10 rounded-2xl rounded-tl-sm p-4 max-w-[80%]">
              <div class="flex gap-2">
                <div class="w-3 h-3 bg-grok-purple rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                <div class="w-3 h-3 bg-grok-purple rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                <div class="w-3 h-3 bg-grok-purple rounded-full animate-bounce" style="animation-delay: 300ms"></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Input Area -->
        <div class="border-t border-white/10 p-4 bg-black/20">
          <div class="flex gap-2">
            <input
              type="text"
              [(ngModel)]="currentMessage"
              (keyup.enter)="sendMessage()"
              placeholder="Ask Grok anything..."
              class="flex-1 bg-white/5 rounded-xl px-4 py-3 border border-white/10 focus:border-grok-purple focus:outline-none transition-all"
              [disabled]="isLoading"
            />
            <button
              (click)="sendMessage()"
              [disabled]="!currentMessage.trim() || isLoading"
              class="px-6 py-3 bg-gradient-to-r from-grok-purple to-grok-pink rounded-xl font-semibold hover:shadow-lg hover:shadow-purple-500/50 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {{ isLoading ? '⏳' : '🚀' }}
            </button>
            <button
              (click)="regenerateResponse()"
              [disabled]="messages.length < 2 || isLoading"
              class="px-4 py-3 glass-effect rounded-xl hover:bg-white/10 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
              title="Regenerate last response"
            >
              🔄
            </button>
          </div>
        </div>
      </div>
      
      <!-- Comparison Branches -->
      <div *ngIf="comparisonMode && comparisonBranches.length > 1" class="space-y-4">
        <div *ngFor="let branch of comparisonBranches.slice(1); let i = index" 
             class="glass-effect rounded-2xl overflow-hidden flex flex-col h-[280px]">
          
          <div class="bg-gradient-to-r from-grok-blue/20 to-grok-pink/20 px-4 py-2 border-b border-white/10">
            <div class="flex justify-between items-center">
              <span class="text-sm font-semibold">Temperature: {{ branch.temperature }}</span>
              <button
                (click)="selectBranchForComparison(i + 1)"
                class="px-3 py-1 bg-grok-purple/30 rounded-lg text-xs hover:bg-grok-purple/50 transition-all"
              >
                Use This
              </button>
            </div>
          </div>
          
          <div class="flex-1 overflow-y-auto p-4 space-y-2 text-sm">
            <div *ngFor="let message of branch.messages.slice(-2)">
              <div *ngIf="message.role === 'assistant'" class="bg-white/5 border border-white/10 rounded-xl p-3">
                <p class="text-gray-100 whitespace-pre-wrap">{{ message.content }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Evaluation Section -->
    <div *ngIf="comparisonMode && comparisonBranches.length > 0" class="mt-4">
      <div class="glass-effect rounded-2xl p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold flex items-center gap-2">
            <span>🎯</span> Output Evaluation
          </h3>
          <button
            (click)="evaluateOutputs()"
            [disabled]="evaluationLoading"
            class="px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl font-semibold hover:shadow-lg transition-all disabled:opacity-50"
          >
            {{ evaluationLoading ? '⏳ Evaluating...' : '✨ Evaluate Outputs' }}
          </button>
        </div>
        
        <div class="mb-4">
          <label class="text-sm text-gray-400 block mb-2">Evaluation Criteria:</label>
          <input
            type="text"
            [(ngModel)]="evaluationCriteria"
            class="w-full bg-black/30 rounded-xl p-3 border border-white/10 focus:border-green-500 focus:outline-none text-sm"
            placeholder="What criteria should be used for evaluation?"
          />
        </div>
        
        <div *ngIf="showEvaluation && evaluationResult" class="bg-gradient-to-br from-green-500/10 to-emerald-500/10 border border-green-500/30 rounded-xl p-4 animate-slide-in">
          <h4 class="font-semibold text-green-400 mb-2">Evaluation Results:</h4>
          <div class="text-gray-200 text-sm whitespace-pre-wrap">{{ evaluationResult }}</div>
        </div>
      </div>
    </div>
    
    <!-- Saved Conversations -->
    <div *ngIf="chatHistory.length > 0" class="mt-8">
      <div class="glass-effect rounded-2xl p-6">
        <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
          <span>📚</span> Saved Conversations
        </h3>
        <div class="grid gap-2">
          <button
            *ngFor="let conv of chatHistory; let i = index"
            (click)="loadConversation(i)"
            class="flex items-center justify-between p-3 bg-white/5 rounded-xl hover:bg-white/10 transition-all text-left"
          >
            <div>
              <div class="font-semibold">{{ conv.name }}</div>
              <div class="text-xs text-gray-400">{{ conv.messages.length }} messages • {{ conv.timestamp | date:'short' }}</div>
            </div>
            <span class="text-2xl">💬</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<app-toast-container></app-toast-container>
<app-install-prompt></app-install-prompt>

<router-outlet />
