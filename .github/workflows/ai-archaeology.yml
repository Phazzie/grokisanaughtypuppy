name: üèõÔ∏è AI Archaeology - Code History Analysis

# Analyzes frequently-changed files to understand technical debt
# Uses Gemini for cost-free analysis

on:
  schedule:
    - cron: '0 3 * * 0'  # Weekly on Sundays at 3 AM
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  analyze-history:
    name: üîç Analyze Code History
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history

      - name: Find Frequently Changed Files
        id: history
        run: |
          echo "## Frequently Modified Files (Last 90 Days)" > analysis.md
          echo "" >> analysis.md

          # Find most changed files
          git log --since="90 days ago" --name-only --pretty=format: \
            | grep -E '\.(js|ts)$' \
            | sort | uniq -c | sort -rn | head -10 > frequent_changes.txt

          echo "### Top 10 Most Modified Files:" >> analysis.md
          while read count file; do
            if [ ! -z "$file" ]; then
              echo "- **$file** ($count changes)" >> analysis.md
            fi
          done < frequent_changes.txt

          echo "" >> analysis.md
          echo "## File History Details" >> analysis.md

          # Get history for top 3 files
          head -3 frequent_changes.txt | while read count file; do
            if [ ! -z "$file" ] && [ -f "$file" ]; then
              echo "" >> analysis.md
              echo "### $file" >> analysis.md
              echo "**Changes:** $count in last 90 days" >> analysis.md
              echo "**Recent commits:**" >> analysis.md
              git log --oneline -5 -- "$file" >> analysis.md || echo "No history" >> analysis.md
            fi
          done

          cat analysis.md

      - name: Analyze with Gemini
        if: ${{ secrets.GEMINI_API_KEY != '' }}
        uses: google-github-actions/run-gemini-cli@v1
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            Analyze this code change history:

            $(cat analysis.md)

            Based on the frequency of changes, identify:
            1. **Code Smell Indicators** - Why are these files changing so often?
            2. **Technical Debt** - What patterns suggest accumulated debt?
            3. **Refactoring Opportunities** - What should be modernized?
            4. **Risk Areas** - Which files are most fragile?

            Provide actionable recommendations for improving code quality.

      - name: Create Archaeological Report Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const analysis = fs.readFileSync('analysis.md', 'utf8');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üèõÔ∏è Code Archaeology Report - ${new Date().toISOString().split('T')[0]}`,
              body: `## Code History Analysis\n\n${analysis}\n\n---\n\n_Generated by AI Archaeology Bot_\n\nFiles that change frequently often indicate:\n- Complex or fragile code\n- Missing abstractions\n- Accumulating technical debt\n- Core business logic areas\n\nReview the analysis above to identify refactoring opportunities.`,
              labels: ['archaeology', 'technical-debt', 'analysis']
            });
