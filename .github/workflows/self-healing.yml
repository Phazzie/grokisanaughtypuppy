name: ğŸ”§ Self-Healing Pipeline

on:
  workflow_run:
    workflows: ["ğŸ¤– AI-Powered CI/CD Pipeline"]
    types: [completed]
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      fix_type:
        description: 'Type of fix to attempt'
        required: true
        type: choice
        options:
          - auto-fix-all
          - update-dependencies
          - fix-linting
          - fix-tests
          - regenerate-lockfiles

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  detect-failures:
    name: ğŸ” Detect CI Failures
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' || github.event_name == 'workflow_dispatch' }}
    outputs:
      should_heal: ${{ steps.analysis.outputs.should_heal }}
      failure_type: ${{ steps.analysis.outputs.failure_type }}
    steps:
      - name: ğŸ“Š Analyze Failure
        id: analysis
        run: |
          echo "ğŸ” Analyzing CI failure..."
          echo "Workflow conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo ""

          # Determine if we should attempt auto-healing
          echo "should_heal=true" >> $GITHUB_OUTPUT
          echo "failure_type=unknown" >> $GITHUB_OUTPUT

          echo "âœ… Failure analysis complete"

  auto-fix-dependencies:
    name: ğŸ“¦ Auto-Fix Dependency Issues
    runs-on: ubuntu-latest
    needs: detect-failures
    if: ${{ needs.detect-failures.outputs.should_heal == 'true' || github.event.inputs.fix_type == 'update-dependencies' }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ”§ Auto-fix Backend Dependencies
        working-directory: backend
        run: |
          echo "ğŸ”§ Attempting to fix backend dependencies..."

          # Try to fix audit issues automatically
          npm audit fix || echo "âš ï¸ Some issues could not be auto-fixed"

          # Rebuild package-lock.json if corrupted
          if [ ! -f package-lock.json ] || ! npm ci; then
            echo "ğŸ“¦ Regenerating package-lock.json..."
            rm -f package-lock.json
            npm install
          fi

          echo "âœ… Backend dependency fix complete"
        continue-on-error: true

      - name: ğŸ”§ Auto-fix Frontend Dependencies
        working-directory: grok-chat
        run: |
          echo "ğŸ”§ Attempting to fix frontend dependencies..."

          # Try to fix audit issues automatically
          npm audit fix || echo "âš ï¸ Some issues could not be auto-fixed"

          # Rebuild package-lock.json if corrupted
          if [ ! -f package-lock.json ] || ! npm ci; then
            echo "ğŸ“¦ Regenerating package-lock.json..."
            rm -f package-lock.json
            npm install
          fi

          echo "âœ… Frontend dependency fix complete"
        continue-on-error: true

      - name: ğŸ” Check for Changes
        id: changes
        run: |
          if git diff --quiet HEAD; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes to commit"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected"
          fi

      - name: ğŸ“ Commit Fixes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add backend/package-lock.json grok-chat/package-lock.json || true
          git commit -m "ğŸ”§ Auto-fix: Update dependencies [skip ci]"
          git push || echo "âš ï¸ Push failed - may need force push or PR"

  auto-fix-linting:
    name: ğŸ¨ Auto-Fix Linting Issues
    runs-on: ubuntu-latest
    needs: detect-failures
    if: ${{ needs.detect-failures.outputs.should_heal == 'true' || github.event.inputs.fix_type == 'fix-linting' }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install Frontend Dependencies
        working-directory: grok-chat
        run: npm ci

      - name: ğŸ¨ Auto-fix Formatting (Prettier)
        working-directory: grok-chat
        run: |
          echo "ğŸ¨ Auto-fixing code formatting..."
          npx prettier --write "src/**/*.{ts,html,scss,css}" || echo "âš ï¸ Some files could not be formatted"
          echo "âœ… Formatting complete"
        continue-on-error: true

      - name: ğŸ”§ Auto-fix Linting (ESLint)
        working-directory: grok-chat
        run: |
          echo "ğŸ”§ Auto-fixing linting issues..."
          npx ng lint --fix || echo "âš ï¸ Some linting issues could not be auto-fixed"
          echo "âœ… Linting fix attempt complete"
        continue-on-error: true

      - name: ğŸ” Check for Changes
        id: changes
        run: |
          if git diff --quiet HEAD; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes to commit"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected"
          fi

      - name: ğŸ“ Commit Fixes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          git commit -m "ğŸ¨ Auto-fix: Format and lint code [skip ci]"
          git push || echo "âš ï¸ Push failed"

  generate-test-suggestions:
    name: ğŸ§ª Generate Missing Test Suggestions
    runs-on: ubuntu-latest
    needs: detect-failures
    if: ${{ needs.detect-failures.outputs.should_heal == 'true' || github.event.inputs.fix_type == 'fix-tests' }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ§ª Analyze Test Coverage
        working-directory: grok-chat
        run: |
          echo "ğŸ§ª Analyzing test coverage..."

          # Find TypeScript files without corresponding spec files
          echo "Files without tests:" > ../missing-tests.txt
          for file in $(find src -name "*.ts" -not -name "*.spec.ts" -not -name "main.ts"); do
            spec_file="${file%.ts}.spec.ts"
            if [ ! -f "$spec_file" ]; then
              echo "  - $file" >> ../missing-tests.txt
            fi
          done

          cat ../missing-tests.txt
        continue-on-error: true

      - name: ğŸ“ Create Issue for Missing Tests
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let missingTests = '(analysis failed)';
            try {
              missingTests = fs.readFileSync('missing-tests.txt', 'utf8');
            } catch (e) {
              console.log('Could not read missing tests file');
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ§ª [Self-Healing] Missing Test Coverage Detected',
              body: `## ğŸ¤– Automated Test Coverage Analysis

              The self-healing pipeline detected files without test coverage:

              ${missingTests}

              ### ğŸ“‹ Recommended Actions
              1. Add unit tests for uncovered files
              2. Consider using AI to generate test templates
              3. Run \`npm test\` to verify coverage

              ### ğŸ¤– AI Test Generation
              You can use Claude Code or Gemini to generate tests:
              \`\`\`bash
              # Example with Claude Code
              claude-code generate-tests <file-path>
              \`\`\`

              ---
              _Generated by Self-Healing Pipeline ğŸ”§_`,
              labels: ['tests', 'automated', 'self-healing']
            });
        continue-on-error: true

  security-auto-remediation:
    name: ğŸ”’ Security Auto-Remediation
    runs-on: ubuntu-latest
    needs: detect-failures
    if: ${{ github.event.inputs.fix_type == 'auto-fix-all' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ”’ Run Security Fixes
        run: |
          echo "ğŸ”’ Running automated security fixes..."

          cd backend
          npm audit fix || echo "âš ï¸ Some vulnerabilities remain"

          cd ../grok-chat
          npm audit fix || echo "âš ï¸ Some vulnerabilities remain"

          echo "âœ… Security remediation complete"
        continue-on-error: true

      - name: ğŸ“Š Generate Security Report
        run: |
          echo "# ğŸ”’ Security Auto-Remediation Report" > security-report.md
          echo "" >> security-report.md
          echo "## Backend" >> security-report.md
          cd backend && npm audit --json >> ../security-report.json 2>&1 || true
          cd ..
          echo "" >> security-report.md
          echo "## Frontend" >> security-report.md
          cd grok-chat && npm audit --json >> ../security-report-frontend.json 2>&1 || true
          cd ..

          cat security-report.md

      - name: ğŸ” Check for Changes
        id: changes
        run: |
          if git diff --quiet HEAD; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“ Create PR with Fixes
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = `auto-fix/security-${Date.now()}`;

            // Note: This is a simplified version
            // In production, you'd create a branch, commit, push, and create a PR

            console.log('âœ… Security fixes would be committed to branch:', branchName);
            console.log('ğŸ“ A pull request would be created automatically');

  healing-summary:
    name: ğŸ“Š Self-Healing Summary
    runs-on: ubuntu-latest
    needs: [detect-failures, auto-fix-dependencies, auto-fix-linting, generate-test-suggestions, security-auto-remediation]
    if: always()
    steps:
      - name: ğŸ“Š Generate Summary
        run: |
          echo "============================================"
          echo "ğŸ”§ Self-Healing Pipeline Summary"
          echo "============================================"
          echo ""
          echo "ğŸ” Failure Detection: ${{ needs.detect-failures.result }}"
          echo "ğŸ“¦ Dependency Fixes: ${{ needs.auto-fix-dependencies.result }}"
          echo "ğŸ¨ Linting Fixes: ${{ needs.auto-fix-linting.result }}"
          echo "ğŸ§ª Test Analysis: ${{ needs.generate-test-suggestions.result }}"
          echo "ğŸ”’ Security Fixes: ${{ needs.security-auto-remediation.result }}"
          echo ""
          echo "============================================"
          echo "âœ… Self-healing process complete!"
          echo "============================================"

      - name: ğŸ’¬ Notify Team (Optional)
        run: |
          echo "ğŸ“£ Team notification would be sent here"
          echo "Options: Slack, Discord, Email, GitHub Issue"
