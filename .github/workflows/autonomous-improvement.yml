name: ðŸ¤– Autonomous Code Improvement

# UNCONVENTIONAL: AI autonomously finds and implements improvements
# Uses official GitHub Actions for AI providers
# Creates PRs for TODOs, performance optimizations, and test generation

on:
  schedule:
    - cron: '0 2 * * 1'  # Every Monday at 2 AM
  workflow_dispatch:
    inputs:
      improvement_type:
        description: 'Type of improvement'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - todos
          - performance
          - tests
          - documentation

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  MAX_CHANGES_PER_RUN: 3
  MAX_COST_USD: 10

jobs:
  # ==========================================================================
  # Scan for improvement opportunities
  # ==========================================================================
  scan-opportunities:
    name: ðŸ” Scan for Improvement Opportunities
    runs-on: ubuntu-latest
    outputs:
      opportunities: ${{ steps.scan.outputs.response }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Find TODOs and FIXMEs
        run: |
          echo "## TODOs Found:" > scan_results.txt
          grep -r "TODO\|FIXME\|XXX\|HACK" --include="*.js" --include="*.ts" backend/ grok-chat/src/ 2>/dev/null >> scan_results.txt || echo "No TODOs found" >> scan_results.txt

      - name: ðŸ“Š Analyze Test Coverage
        run: |
          echo "" >> scan_results.txt
          echo "## Files Without Tests:" >> scan_results.txt

          # Find JS/TS files that don't have corresponding test files
          find backend -name "*.js" ! -name "*.spec.js" ! -name "*.test.js" 2>/dev/null | while read file; do
            basename="${file%.*}"
            if [ ! -f "${basename}.spec.js" ] && [ ! -f "${basename}.test.js" ]; then
              echo "- $file (no test file)" >> scan_results.txt
            fi
          done

      - name: ðŸŽ¯ AI Analysis of Opportunities (Claude Max)
        id: scan
        if: ${{ secrets.ANTHROPIC_API_KEY != '' || secrets.CLAUDE_CODE_OAUTH_TOKEN != '' || secrets.GEMINI_API_KEY != '' }}
        uses: anthropics/claude-code-action@v1
        with:
          # Supports BOTH Claude Max (OAuth) and API key
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You are an autonomous code improvement system. Analyze this codebase for opportunities.

            **Scan Results:**
            $(cat scan_results.txt)

            **Recent Commits (for context):**
            $(git log --oneline -10)

            **Task:** Identify the TOP 3 most valuable improvements:

            Focus on:
            1. **Implement TODOs** - Pick ones that add real value
            2. **Add Missing Tests** - Critical untested code
            3. **Performance Optimizations** - Low-hanging fruit
            4. **Documentation Gaps** - Confusing code that needs docs

            Output JSON:
            {
              "opportunities": [
                {
                  "type": "todo|test|performance|documentation",
                  "priority": 1-10,
                  "file": "path/to/file",
                  "description": "...",
                  "estimated_value": "high|medium|low",
                  "implementation_complexity": "easy|medium|hard"
                }
              ],
              "recommended_order": [0, 1, 2]
            }

            Only return opportunities where implementation_complexity is "easy" or "medium".
            Prioritize high estimated_value items.

      - name: ðŸ’¾ Save Opportunities
        run: |
          echo '${{ steps.scan.outputs.response }}' > opportunities.json
          echo "ðŸ“Š Found opportunities:"
          cat opportunities.json

      - name: ðŸ“¤ Upload Opportunities
        uses: actions/upload-artifact@v4
        with:
          name: improvement-opportunities
          path: opportunities.json

  # ==========================================================================
  # Implement improvements autonomously
  # ==========================================================================
  implement-improvements:
    name: ðŸ› ï¸ Implement Improvements
    runs-on: ubuntu-latest
    needs: scan-opportunities
    strategy:
      matrix:
        improvement_index: [0, 1, 2]  # Process top 3 opportunities
      max-parallel: 1  # Do them one at a time to avoid conflicts
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¥ Download Opportunities
        uses: actions/download-artifact@v4
        with:
          name: improvement-opportunities

      - name: ðŸŽ¯ Get Specific Opportunity
        id: opportunity
        run: |
          OPPORTUNITY=$(jq -r ".opportunities[${{ matrix.improvement_index }}] // null" opportunities.json)

          if [ "$OPPORTUNITY" == "null" ]; then
            echo "No opportunity at index ${{ matrix.improvement_index }}"
            echo "exists=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "exists=true" >> $GITHUB_OUTPUT
          echo "$OPPORTUNITY" > current_opportunity.json

          TYPE=$(echo "$OPPORTUNITY" | jq -r '.type')
          FILE=$(echo "$OPPORTUNITY" | jq -r '.file')
          DESC=$(echo "$OPPORTUNITY" | jq -r '.description')

          echo "type=$TYPE" >> $GITHUB_OUTPUT
          echo "file=$FILE" >> $GITHUB_OUTPUT
          echo "description=$DESC" >> $GITHUB_OUTPUT

          echo "ðŸŽ¯ Working on: $DESC"

      - name: ðŸ“– Read Current Code
        if: steps.opportunity.outputs.exists == 'true'
        run: |
          FILE="${{ steps.opportunity.outputs.file }}"
          if [ -f "$FILE" ]; then
            cat "$FILE" > current_code.txt
            echo "âœ… Read $FILE"
          else
            echo "âŒ File not found: $FILE"
            echo "" > current_code.txt
          fi

      - name: ðŸ¤– AI Implementation (Claude Max)
        id: implement
        if: steps.opportunity.outputs.exists == 'true' && (secrets.ANTHROPIC_API_KEY != '' || secrets.CLAUDE_CODE_OAUTH_TOKEN != '' || secrets.GEMINI_API_KEY != '')
        uses: anthropics/claude-code-action@v1
        with:
          # Supports BOTH Claude Max (OAuth) and API key
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You are implementing this improvement:

            **Type**: ${{ steps.opportunity.outputs.type }}
            **File**: ${{ steps.opportunity.outputs.file }}
            **Task**: ${{ steps.opportunity.outputs.description }}

            **Current Code:**
            $(cat current_code.txt)

            **Instructions:**
            1. Implement the improvement described
            2. Maintain existing code style and conventions
            3. Add appropriate comments
            4. Ensure backward compatibility
            5. Do NOT add secrets or API keys

            Output the COMPLETE new file content.
            No explanations, just the code.

      - name: ðŸ” Security Scan of AI-Generated Code
        if: steps.opportunity.outputs.exists == 'true'
        run: |
          # Check for common secret patterns
          CONTENT='${{ steps.implement.outputs.response }}'

          if echo "$CONTENT" | grep -iE "(api[_-]?key|secret|password|token).*=.*['\"][a-zA-Z0-9]{20,}" > secrets_found.txt; then
            echo "âš ï¸ SECURITY WARNING: Possible secrets detected in AI-generated code!"
            cat secrets_found.txt
            echo "âŒ Rejecting this change for security reasons"
            exit 1
          fi

          echo "âœ… Security scan passed"

      - name: âœï¸ Write Improved Code
        if: steps.opportunity.outputs.exists == 'true'
        run: |
          FILE="${{ steps.opportunity.outputs.file }}"
          echo '${{ steps.implement.outputs.response }}' > "$FILE"
          echo "âœ… Updated $FILE"

      - name: ðŸ“¦ Setup Node.js for Testing
        if: steps.opportunity.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ§ª Verify Changes Don't Break Anything
        if: steps.opportunity.outputs.exists == 'true'
        run: |
          # Try to parse/validate the changes
          FILE="${{ steps.opportunity.outputs.file }}"

          if [[ "$FILE" == *.js ]]; then
            node -c "$FILE" && echo "âœ… JavaScript syntax valid"
          elif [[ "$FILE" == *.ts ]]; then
            echo "âœ… TypeScript file (would need tsc to validate)"
          fi

      - name: ðŸŒ¿ Create Branch and Commit
        if: steps.opportunity.outputs.exists == 'true'
        run: |
          BRANCH_NAME="autonomous-improvement-${{ matrix.improvement_index }}-${{ github.run_number }}"

          git config user.name "Autonomous Improvement Bot"
          git config user.email "autonomous-bot@github-actions"

          git checkout -b "$BRANCH_NAME"

          git add "${{ steps.opportunity.outputs.file }}"
          git commit -m "ðŸ¤– Autonomous improvement: ${{ steps.opportunity.outputs.description }}" --no-gpg-sign

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV

      - name: ðŸ“¤ Push Branch
        if: steps.opportunity.outputs.exists == 'true'
        run: |
          git push -u origin "${{ env.branch_name }}" || echo "âš ï¸ Could not push branch"

      - name: ðŸ“ Create Pull Request
        if: steps.opportunity.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const opportunity = require('./current_opportunity.json');

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ¤– Autonomous: ${opportunity.description}`,
              head: '${{ env.branch_name }}',
              base: 'main',
              body: `## ðŸ¤– Autonomous Code Improvement

            **Type**: ${opportunity.type}
            **Priority**: ${opportunity.priority}/10
            **Estimated Value**: ${opportunity.estimated_value}
            **Complexity**: ${opportunity.implementation_complexity}

            ### What Changed
            ${opportunity.description}

            ### File Modified
            - \`${opportunity.file}\`

            ### Review Notes
            âš ï¸ This PR was created autonomously by AI. Please review carefully before merging.

            - [ ] Code changes look correct
            - [ ] No security issues introduced
            - [ ] Tests pass
            - [ ] Documentation updated if needed

            ---
            _Generated by Autonomous Improvement Bot â€¢ Run #${{ github.run_number }}_
            `
            });

            console.log(`Created PR #${pr.data.number}`);

  # ==========================================================================
  # Summary Report
  # ==========================================================================
  report-summary:
    name: ðŸ“Š Generate Summary Report
    runs-on: ubuntu-latest
    needs: [scan-opportunities, implement-improvements]
    if: always()
    steps:
      - name: ðŸ“¥ Download Opportunities
        uses: actions/download-artifact@v4
        with:
          name: improvement-opportunities

      - name: ðŸ“Š Generate Summary
        run: |
          cat > summary.md << 'SUMMARY'
          # ðŸ¤– Autonomous Improvement Run Summary

          **Run**: #${{ github.run_number }}
          **Date**: $(date -Iseconds)

          ## Opportunities Found
          $(jq -r '.opportunities[] | "- **" + .type + "**: " + .description + " (priority: " + (.priority|tostring) + "/10)"' opportunities.json)

          ## Actions Taken
          Check the pull requests created by this run for details.

          ## Next Steps
          - Review and merge the PRs created by the autonomous bot
          - Monitor for any issues introduced by the changes
          - The bot will continue to find and implement improvements weekly

          ---
          _Autonomous Improvement Bot runs every Monday at 2 AM_
          SUMMARY

          cat summary.md

      - name: ðŸ’¬ Post Summary as Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('summary.md', 'utf8');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ¤– Autonomous Improvement Summary - Run #${{ github.run_number }}`,
              body: summary,
              labels: ['autonomous', 'bot', 'improvement']
            });
