name: ü§ñ Autonomous Code Improvement

# AI scans for TODOs and creates improvement PRs
# Uses Claude Max for code generation

on:
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Mondays at 2 AM
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  scan-todos:
    name: üîç Scan for TODO Items
    runs-on: ubuntu-latest
    outputs:
      has_todos: ${{ steps.scan.outputs.found }}
    steps:
      - uses: actions/checkout@v4

      - name: Find TODOs
        id: scan
        run: |
          echo "## TODOs and FIXMEs Found:" > todos.md
          grep -rn "TODO\|FIXME\|XXX\|HACK" --include="*.js" --include="*.ts" backend/ grok-chat/src/ 2>/dev/null >> todos.md || echo "No TODOs found" >> todos.md

          if grep -q "TODO\|FIXME" todos.md; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Found TODOs to work on"
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No TODOs found"
          fi

          cat todos.md

      - name: Upload TODO List
        if: steps.scan.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: todo-list
          path: todos.md

  create-improvement-issue:
    name: üìù Create Improvement Tracking Issue
    runs-on: ubuntu-latest
    needs: scan-todos
    if: needs.scan-todos.outputs.has_todos == 'true' && (secrets.ANTHROPIC_API_KEY != '' || secrets.CLAUDE_CODE_OAUTH_TOKEN != '' || secrets.GEMINI_API_KEY != '')
    steps:
      - uses: actions/checkout@v4

      - name: Download TODO List
        uses: actions/download-artifact@v4
        with:
          name: todo-list

      - name: Analyze with Claude
        if: ${{ secrets.ANTHROPIC_API_KEY != '' || secrets.CLAUDE_CODE_OAUTH_TOKEN != '' }}
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            I found these TODOs in the codebase:

            $(cat todos.md)

            Please analyze and prioritize them. Create a markdown formatted report with:
            1. High priority TODOs (security, bugs, critical features)
            2. Medium priority (performance, refactoring)
            3. Low priority (nice-to-haves, documentation)

            For each TODO, suggest:
            - Why it's important
            - Estimated effort (easy/medium/hard)
            - Any dependencies

      - name: Create GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const todos = fs.readFileSync('todos.md', 'utf8');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ü§ñ Autonomous Improvement Scan - ${new Date().toISOString().split('T')[0]}`,
              body: `## TODOs Found in Codebase\n\n${todos}\n\n---\n\n_Generated by Autonomous Improvement Bot ‚Ä¢ Run #${context.runNumber}_\n\n**Next Steps:**\n- Review prioritized TODO list above\n- AI can implement high-priority items\n- Comment on this issue to assign specific TODOs`,
              labels: ['autonomous', 'improvement', 'todo-scan']
            });
