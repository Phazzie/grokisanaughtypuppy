name: ðŸŽ­ Adversarial Security Testing

# AI generates security test scenarios and evaluates defenses
# Uses Claude Max for security-critical analysis

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * 2'  # Weekly on Tuesdays at 4 AM

permissions:
  contents: read
  pull-requests: write
  issues: write
  security-events: write

jobs:
  security-analysis:
    name: ðŸ”’ Security Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Analyze Attack Surface
        id: surface
        run: |
          echo "## API Endpoints" > attack_surface.md
          grep -rn "router\.\(get\|post\|put\|delete\)" backend/ --include="*.js" 2>/dev/null >> attack_surface.md || echo "No routes found" >> attack_surface.md

          echo "" >> attack_surface.md
          echo "## Authentication/Authorization" >> attack_surface.md
          grep -rn "auth\|token\|jwt" backend/ --include="*.js" 2>/dev/null | head -10 >> attack_surface.md || echo "No auth found" >> attack_surface.md

          echo "" >> attack_surface.md
          echo "## Database Queries" >> attack_surface.md
          grep -rn "query\|execute" backend/ --include="*.js" 2>/dev/null | head -10 >> attack_surface.md || echo "No queries found" >> attack_surface.md

          cat attack_surface.md

      - name: AI Security Review with Claude
        if: ${{ secrets.ANTHROPIC_API_KEY != '' || secrets.CLAUDE_CODE_OAUTH_TOKEN != '' }}
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            Conduct a security review focusing on this attack surface:

            $(cat attack_surface.md)

            Identify potential vulnerabilities:
            1. **SQL Injection** - Unsafe database queries
            2. **Authentication Bypass** - Weak auth checks
            3. **Authorization Issues** - Missing permission checks
            4. **XSS** - Unescaped user input
            5. **CSRF** - Missing CSRF tokens
            6. **Rate Limiting** - No protection against abuse

            For each finding, provide:
            - Severity (Critical/High/Medium/Low)
            - Specific code location
            - Exploitation scenario
            - Remediation steps

  npm-audit:
    name: ðŸ” NPM Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Audit Backend Dependencies
        working-directory: backend
        run: |
          npm audit --audit-level=moderate || true
          npm audit --json > ../backend-audit.json || true

      - name: Audit Frontend Dependencies
        working-directory: grok-chat
        run: |
          npm audit --audit-level=moderate || true
          npm audit --json > ../frontend-audit.json || true

      - name: Upload Audit Results
        uses: actions/upload-artifact@v4
        with:
          name: security-audit
          path: |
            backend-audit.json
            frontend-audit.json

  codeql-analysis:
    name: ðŸ”¬ CodeQL Security Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  summary:
    name: ðŸ“Š Security Summary
    runs-on: ubuntu-latest
    needs: [security-analysis, npm-audit, codeql-analysis]
    if: always()
    steps:
      - name: Create Security Report
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const summary = `## ðŸŽ­ Adversarial Security Testing Complete

            âœ… AI Security Analysis: ${{ needs.security-analysis.result }}
            âœ… NPM Audit: ${{ needs.npm-audit.result }}
            âœ… CodeQL Scan: ${{ needs.codeql-analysis.result }}

            **Next Steps:**
            - Review AI security findings above
            - Check npm audit results for vulnerable dependencies
            - Review CodeQL findings in Security tab

            _Automated security testing helps find vulnerabilities before attackers do._
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: summary
            });
