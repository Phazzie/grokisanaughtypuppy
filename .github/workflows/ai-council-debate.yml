name: üß† AI Council - Multi-Agent Code Review

# Three AIs review pull requests and provide synthesis
# Uses Claude Code Action and Gemini CLI Action properly

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # ==============================================================================
  # Claude Code Review (High Quality)
  # ==============================================================================
  claude-review:
    name: üé≠ Claude Code Review
    runs-on: ubuntu-latest
    if: ${{ secrets.ANTHROPIC_API_KEY != '' || secrets.CLAUDE_CODE_OAUTH_TOKEN != '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            Please conduct a thorough code review of this PR focusing on:

            1. **Security vulnerabilities** - SQL injection, XSS, auth bypasses
            2. **Performance issues** - N+1 queries, memory leaks, blocking operations
            3. **Architecture problems** - Design flaws, tight coupling
            4. **Hidden bugs** - Edge cases, race conditions, error handling
            5. **Technical debt** - Code smells, maintainability issues

            Be critical and thorough. Format your response clearly with:
            - Critical Issues (must fix)
            - Medium Priority Issues
            - Suggestions for improvement

            Use markdown formatting for the review.

  # ==============================================================================
  # Gemini Code Review (Free Alternative)
  # ==============================================================================
  gemini-review:
    name: üíé Gemini Code Review
    runs-on: ubuntu-latest
    if: ${{ secrets.GEMINI_API_KEY != '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Run Gemini Code Review
        uses: google-github-actions/run-gemini-cli@v1
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            Analyze this pull request from a security and performance perspective:

            1. Security flaws - authentication, authorization, injection
            2. Performance killers - slow queries, blocking operations
            3. Scalability concerns - will this work at scale?
            4. Error handling - what happens when things fail?

            Provide specific, actionable feedback.

  # ==============================================================================
  # Manual Review Collection (fallback if AI unavailable)
  # ==============================================================================
  manual-review-needed:
    name: üìù Manual Review Required
    runs-on: ubuntu-latest
    if: ${{ secrets.ANTHROPIC_API_KEY == '' && secrets.CLAUDE_CODE_OAUTH_TOKEN == '' && secrets.GEMINI_API_KEY == '' }}
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## ‚ö†Ô∏è AI Review Not Configured

              No AI API keys found. To enable AI-powered reviews:

              **Option 1: Claude Max (OAuth)**
              1. Run \`claude setup-token\` in your terminal
              2. Add token as \`CLAUDE_CODE_OAUTH_TOKEN\` secret

              **Option 2: Free Gemini**
              1. Get key from https://aistudio.google.com/apikey
              2. Add as \`GEMINI_API_KEY\` secret

              **Option 3: Anthropic API**
              1. Get key from https://console.anthropic.com
              2. Add as \`ANTHROPIC_API_KEY\` secret

              See \`CLAUDE-MAX-SETUP.md\` for detailed instructions.
              `
            });
