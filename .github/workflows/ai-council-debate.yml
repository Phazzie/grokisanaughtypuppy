name: üß† AI Council - Multi-Agent Code Review Debate

# UNCONVENTIONAL: Three AIs debate each other's findings
# Uses official GitHub Actions for Claude, Gemini, and Copilot
# The most critical/agreed-upon issues rise to the top

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # ==========================================================================
  # ROUND 1: Independent Reviews (All AIs review simultaneously)
  # ==========================================================================
  claude-independent-review:
    name: üé≠ Claude's Independent Analysis
    runs-on: ubuntu-latest
    if: ${{ secrets.ANTHROPIC_API_KEY != '' }}
    outputs:
      review_json: ${{ steps.review.outputs.result }}
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìä Get PR Diff
        id: diff
        run: |
          git diff origin/${{ github.event.pull_request.base.ref }}...HEAD > pr_diff.txt
          echo "diff_size=$(wc -l < pr_diff.txt)" >> $GITHUB_OUTPUT

      - name: üé≠ Claude Deep Analysis
        id: review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are a senior architect conducting a deep code review. Analyze this PR critically:

            1. **Security Vulnerabilities** - Find potential exploits
            2. **Performance Issues** - Identify bottlenecks and inefficiencies
            3. **Architecture Problems** - Detect design flaws
            4. **Hidden Bugs** - Find edge cases and race conditions
            5. **Technical Debt** - Identify future maintenance nightmares

            Be CRITICAL. Find the problems that will cause production incidents.
            Output ONLY JSON in this format:
            {
              "critical_issues": [{"type": "...", "severity": 1-10, "finding": "...", "evidence": "...", "confidence": 1-10}],
              "recommendations": ["..."],
              "overall_risk": 1-10
            }

      - name: üíæ Save Claude Review
        run: |
          echo '${{ steps.review.outputs.response }}' > claude_review.json
          cat claude_review.json

      - name: üì§ Upload Claude Review
        uses: actions/upload-artifact@v4
        with:
          name: claude-review
          path: claude_review.json

  gemini-independent-review:
    name: üíé Gemini's Independent Analysis
    runs-on: ubuntu-latest
    if: ${{ secrets.GEMINI_API_KEY != '' }}
    outputs:
      review_json: ${{ steps.review.outputs.response }}
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìä Get PR Diff
        run: git diff origin/${{ github.event.pull_request.base.ref }}...HEAD > pr_diff.txt

      - name: üíé Gemini Deep Analysis
        id: review
        uses: google-github-actions/run-gemini-cli@v1
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            You are a security expert and performance specialist. Review this code:

            1. **Security Flaws** - Authentication, authorization, injection vulnerabilities
            2. **Performance Killers** - N+1 queries, memory leaks, blocking operations
            3. **Scalability Issues** - Will this work at 100x scale?
            4. **Error Handling** - What happens when things go wrong?
            5. **Data Integrity** - Can data get corrupted?

            Be SKEPTICAL. Assume this will run in production tomorrow.
            Output ONLY JSON in this format:
            {
              "critical_issues": [{"type": "...", "severity": 1-10, "finding": "...", "evidence": "...", "confidence": 1-10}],
              "recommendations": ["..."],
              "overall_risk": 1-10
            }

      - name: üíæ Save Gemini Review
        run: |
          echo '${{ steps.review.outputs.response }}' > gemini_review.json
          cat gemini_review.json

      - name: üì§ Upload Gemini Review
        uses: actions/upload-artifact@v4
        with:
          name: gemini-review
          path: gemini_review.json

  copilot-independent-review:
    name: üêô Copilot's Independent Analysis
    runs-on: ubuntu-latest
    outputs:
      review_json: ${{ steps.review.outputs.result }}
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìä Get PR Diff
        run: git diff origin/${{ github.event.pull_request.base.ref }}...HEAD > pr_diff.txt

      - name: üêô Copilot Deep Analysis
        id: review
        run: |
          # Install GitHub CLI and Copilot extension
          type gh &>/dev/null || (curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg && \
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg && \
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null && \
          sudo apt update && \
          sudo apt install gh -y)

          gh extension install github/gh-copilot 2>/dev/null || true

          cat > copilot_prompt.txt << 'PROMPT'
          You are a pragmatic engineer focused on maintainability. Review this code:

          1. **Readability Issues** - Will future developers understand this?
          2. **Testing Gaps** - What's not being tested?
          3. **Best Practices** - What conventions are violated?
          4. **Dependencies** - Are we adding technical debt?
          5. **Documentation** - Is this self-explanatory?

          Be PRACTICAL. Think about the next developer maintaining this.
          Output ONLY JSON in this format:
          {
            "critical_issues": [{"type": "...", "severity": 1-10, "finding": "...", "evidence": "...", "confidence": 1-10}],
            "recommendations": ["..."],
            "overall_risk": 1-10
          }
          PROMPT

          # Run Copilot analysis
          gh copilot suggest "$(cat copilot_prompt.txt)" > copilot_review.json || echo '{"critical_issues":[],"recommendations":[],"overall_risk":0}' > copilot_review.json

          echo "result<<EOF" >> $GITHUB_OUTPUT
          cat copilot_review.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üì§ Upload Copilot Review
        uses: actions/upload-artifact@v4
        with:
          name: copilot-review
          path: copilot_review.json

  # ==========================================================================
  # ROUND 2: AI Debate (AIs challenge each other's findings)
  # ==========================================================================
  ai-council-debate:
    name: ‚öñÔ∏è AI Council Debate & Consensus
    runs-on: ubuntu-latest
    needs: [claude-independent-review, gemini-independent-review, copilot-independent-review]
    if: always()
    steps:
      - name: üì• Download All Reviews
        uses: actions/download-artifact@v4
        with:
          path: reviews/

      - name: ü§î Synthesize Reviews with Claude
        id: synthesize
        if: ${{ secrets.ANTHROPIC_API_KEY != '' }}
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are the moderator of an AI council. Three AIs have reviewed the same code.

            Your job:
            1. **Find Consensus** - What did all AIs agree on? (Highest priority)
            2. **Identify Conflicts** - Where do they disagree? Why?
            3. **Challenge Weak Findings** - Which concerns lack evidence?
            4. **Synthesize Action Items** - What MUST be fixed vs. nice-to-have?
            5. **Risk Assessment** - Weighted risk score based on agreement

            Output format:
            {
              "consensus_critical_issues": [{"issue": "...", "agreed_by": ["claude", "gemini", "copilot"], "severity": 1-10}],
              "debated_issues": [{"issue": "...", "claude_says": "...", "gemini_says": "...", "copilot_says": "..."}],
              "must_fix": ["..."],
              "nice_to_have": ["..."],
              "overall_risk": 1-10,
              "recommendation": "approve|request_changes|needs_discussion"
            }

      - name: üíæ Save Council Decision
        run: |
          echo '${{ steps.synthesize.outputs.response }}' > council_decision.json
          cat council_decision.json

      - name: üìä Generate Visual Report
        run: |
          cat > council_report.md << 'REPORT'
          # üß† AI Council Review Results

          ## ‚öñÔ∏è Council Decision

          **Overall Risk**: $(jq -r '.overall_risk // "N/A"' council_decision.json)/10
          **Recommendation**: $(jq -r '.recommendation // "N/A"' council_decision.json)

          ---

          ## üéØ Consensus Issues (All AIs Agree)

          These issues were identified by multiple AIs and should be prioritized:

          $(jq -r '.consensus_critical_issues[]? | "### " + .issue + "\n**Severity**: " + (.severity|tostring) + "/10\n**Agreed by**: " + (.agreed_by|join(", ")) + "\n"' council_decision.json || echo "_No consensus issues found_")

          ---

          ## ü§î Debated Issues (AIs Disagree)

          These issues need human judgment:

          $(jq -r '.debated_issues[]? | "### " + .issue + "\n- üé≠ **Claude**: " + .claude_says + "\n- üíé **Gemini**: " + .gemini_says + "\n- üêô **Copilot**: " + .copilot_says + "\n"' council_decision.json || echo "_No debated issues found_")

          ---

          ## ‚úÖ Must Fix Before Merge

          $(jq -r '.must_fix[]? | "- [ ] " + .' council_decision.json || echo "_No critical fixes required_")

          ---

          ## üí° Nice to Have

          $(jq -r '.nice_to_have[]? | "- " + .' council_decision.json || echo "_No suggestions_")

          ---

          ## üìä Individual AI Reports

          <details>
          <summary>üé≠ Claude's Full Analysis</summary>

          \`\`\`json
          $(cat reviews/claude-review/claude_review.json 2>/dev/null || echo "{}")
          \`\`\`

          </details>

          <details>
          <summary>üíé Gemini's Full Analysis</summary>

          \`\`\`json
          $(cat reviews/gemini-review/gemini_review.json 2>/dev/null || echo "{}")
          \`\`\`

          </details>

          <details>
          <summary>üêô Copilot's Full Analysis</summary>

          \`\`\`json
          $(cat reviews/copilot-review/copilot_review.json 2>/dev/null || echo "{}")
          \`\`\`

          </details>

          ---

          _Generated by AI Council - Where Multiple AIs Debate Your Code_ üß†

          **Implementation Note**: This workflow uses official GitHub Actions:
          - `anthropics/claude-code-action@v1`
          - `google-github-actions/run-gemini-cli@v1`
          - GitHub Copilot CLI (built-in)
          REPORT

      - name: üí¨ Post Council Decision to PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('council_report.md', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: report
            });

      - name: ‚ùå Fail if Critical Issues Found
        run: |
          RISK=$(jq -r '.overall_risk // 0' council_decision.json)
          if [ "$RISK" -gt 7 ]; then
            echo "‚ùå AI Council has determined this PR is too risky (risk: $RISK/10)"
            exit 1
          fi
          echo "‚úÖ Risk level acceptable ($RISK/10)"
