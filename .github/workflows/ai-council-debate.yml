name: ğŸ§  AI Council - Multi-Agent Code Review Debate

# UNCONVENTIONAL: Three AIs debate each other's findings
# Claude, Gemini, and Copilot independently review, then challenge each other
# The most critical/agreed-upon issues rise to the top

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # ==========================================================================
  # ROUND 1: Independent Reviews (All AIs review simultaneously)
  # ==========================================================================
  claude-independent-review:
    name: ğŸ­ Claude's Independent Analysis
    runs-on: ubuntu-latest
    if: ${{ secrets.CLAUDE_CODE_API_KEY != '' }}
    outputs:
      review_json: ${{ steps.review.outputs.result }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“Š Get PR Diff
        id: diff
        run: |
          git diff origin/${{ github.event.pull_request.base.ref }}...HEAD > pr_diff.txt
          echo "diff_size=$(wc -l < pr_diff.txt)" >> $GITHUB_OUTPUT

      - name: ğŸ­ Claude Deep Analysis
        id: review
        env:
          CLAUDE_CODE_API_KEY: ${{ secrets.CLAUDE_CODE_API_KEY }}
        run: |
          # Use Claude CLI in headless mode
          cat > claude_prompt.txt << 'PROMPT'
          You are a senior architect conducting a deep code review. Analyze this PR critically:

          1. **Security Vulnerabilities** - Find potential exploits
          2. **Performance Issues** - Identify bottlenecks and inefficiencies
          3. **Architecture Problems** - Detect design flaws
          4. **Hidden Bugs** - Find edge cases and race conditions
          5. **Technical Debt** - Identify future maintenance nightmares

          Be CRITICAL. Find the problems that will cause production incidents.
          Output ONLY JSON in this format:
          {
            "critical_issues": [{"type": "...", "severity": 1-10, "finding": "...", "evidence": "...", "confidence": 1-10}],
            "recommendations": ["..."],
            "overall_risk": 1-10
          }
          PROMPT

          # Run Claude in headless mode
          claude -p "$(cat claude_prompt.txt)" --output-format stream-json < pr_diff.txt > claude_review.json || echo '{"critical_issues":[],"recommendations":[],"overall_risk":0}' > claude_review.json

          echo "result<<EOF" >> $GITHUB_OUTPUT
          cat claude_review.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ“¤ Upload Claude Review
        uses: actions/upload-artifact@v4
        with:
          name: claude-review
          path: claude_review.json

  gemini-independent-review:
    name: ğŸ’ Gemini's Independent Analysis
    runs-on: ubuntu-latest
    if: ${{ secrets.GOOGLE_API_KEY != '' }}
    outputs:
      review_json: ${{ steps.review.outputs.result }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“Š Get PR Diff
        run: git diff origin/${{ github.event.pull_request.base.ref }}...HEAD > pr_diff.txt

      - name: ğŸ’ Gemini Deep Analysis
        id: review
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          cat > gemini_prompt.txt << 'PROMPT'
          You are a security expert and performance specialist. Review this code:

          1. **Security Flaws** - Authentication, authorization, injection vulnerabilities
          2. **Performance Killers** - N+1 queries, memory leaks, blocking operations
          3. **Scalability Issues** - Will this work at 100x scale?
          4. **Error Handling** - What happens when things go wrong?
          5. **Data Integrity** - Can data get corrupted?

          Be SKEPTICAL. Assume this will run in production tomorrow.
          Output ONLY JSON in this format:
          {
            "critical_issues": [{"type": "...", "severity": 1-10, "finding": "...", "evidence": "...", "confidence": 1-10}],
            "recommendations": ["..."],
            "overall_risk": 1-10
          }
          PROMPT

          # Run Gemini CLI in headless mode
          gemini -p "$(cat gemini_prompt.txt)" --yolo --format json < pr_diff.txt > gemini_review.json || echo '{"critical_issues":[],"recommendations":[],"overall_risk":0}' > gemini_review.json

          echo "result<<EOF" >> $GITHUB_OUTPUT
          cat gemini_review.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ“¤ Upload Gemini Review
        uses: actions/upload-artifact@v4
        with:
          name: gemini-review
          path: gemini_review.json

  copilot-independent-review:
    name: ğŸ™ Copilot's Independent Analysis
    runs-on: ubuntu-latest
    outputs:
      review_json: ${{ steps.review.outputs.result }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“Š Get PR Diff
        run: git diff origin/${{ github.event.pull_request.base.ref }}...HEAD > pr_diff.txt

      - name: ğŸ™ Copilot Deep Analysis
        id: review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Install Copilot CLI
          gh extension install github/gh-copilot 2>/dev/null || true

          cat > copilot_prompt.txt << 'PROMPT'
          You are a pragmatic engineer focused on maintainability. Review this code:

          1. **Readability Issues** - Will future developers understand this?
          2. **Testing Gaps** - What's not being tested?
          3. **Best Practices** - What conventions are violated?
          4. **Dependencies** - Are we adding technical debt?
          5. **Documentation** - Is this self-explanatory?

          Be PRACTICAL. Think about the next developer maintaining this.
          Output ONLY JSON in this format:
          {
            "critical_issues": [{"type": "...", "severity": 1-10, "finding": "...", "evidence": "...", "confidence": 1-10}],
            "recommendations": ["..."],
            "overall_risk": 1-10
          }
          PROMPT

          # Run Copilot in programmatic mode
          gh copilot -p "$(cat copilot_prompt.txt)" --allow-all-tools --output-format json < pr_diff.txt > copilot_review.json || echo '{"critical_issues":[],"recommendations":[],"overall_risk":0}' > copilot_review.json

          echo "result<<EOF" >> $GITHUB_OUTPUT
          cat copilot_review.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ“¤ Upload Copilot Review
        uses: actions/upload-artifact@v4
        with:
          name: copilot-review
          path: copilot_review.json

  # ==========================================================================
  # ROUND 2: AI Debate (AIs challenge each other's findings)
  # ==========================================================================
  ai-council-debate:
    name: âš–ï¸ AI Council Debate & Consensus
    runs-on: ubuntu-latest
    needs: [claude-independent-review, gemini-independent-review, copilot-independent-review]
    if: always()
    steps:
      - name: ğŸ“¥ Download All Reviews
        uses: actions/download-artifact@v4
        with:
          path: reviews/

      - name: ğŸ¤” Synthesize Reviews
        id: synthesize
        run: |
          cat > debate_prompt.txt << 'DEBATE'
          You are the moderator of an AI council. Three AIs have reviewed the same code:

          Claude's Review: $(cat reviews/claude-review/claude_review.json 2>/dev/null || echo '{}')
          Gemini's Review: $(cat reviews/gemini-review/gemini_review.json 2>/dev/null || echo '{}')
          Copilot's Review: $(cat reviews/copilot-review/copilot_review.json 2>/dev/null || echo '{}')

          Your job:
          1. **Find Consensus** - What did all AIs agree on? (Highest priority)
          2. **Identify Conflicts** - Where do they disagree? Why?
          3. **Challenge Weak Findings** - Which concerns lack evidence?
          4. **Synthesize Action Items** - What MUST be fixed vs. nice-to-have?
          5. **Risk Assessment** - Weighted risk score based on agreement

          Output format:
          {
            "consensus_critical_issues": [{"issue": "...", "agreed_by": ["claude", "gemini", "copilot"], "severity": 1-10}],
            "debated_issues": [{"issue": "...", "claude_says": "...", "gemini_says": "...", "copilot_says": "..."}],
            "must_fix": ["..."],
            "nice_to_have": ["..."],
            "overall_risk": 1-10,
            "recommendation": "approve|request_changes|needs_discussion"
          }
          DEBATE

          # Use the most available AI for synthesis
          if [ -n "${{ secrets.CLAUDE_CODE_API_KEY }}" ]; then
            claude -p "$(cat debate_prompt.txt)" --output-format stream-json > council_decision.json
          elif [ -n "${{ secrets.GOOGLE_API_KEY }}" ]; then
            gemini -p "$(cat debate_prompt.txt)" --yolo --format json > council_decision.json
          else
            echo '{"consensus_critical_issues":[],"must_fix":[],"overall_risk":0,"recommendation":"approve"}' > council_decision.json
          fi

          cat council_decision.json

      - name: ğŸ“Š Generate Visual Report
        run: |
          cat > council_report.md << 'REPORT'
          # ğŸ§  AI Council Review Results

          ## âš–ï¸ Council Decision

          **Overall Risk**: $(jq -r '.overall_risk' council_decision.json)/10
          **Recommendation**: $(jq -r '.recommendation' council_decision.json)

          ---

          ## ğŸ¯ Consensus Issues (All AIs Agree)

          These issues were identified by multiple AIs and should be prioritized:

          $(jq -r '.consensus_critical_issues[] | "### " + .issue + "\n**Severity**: " + (.severity|tostring) + "/10\n**Agreed by**: " + (.agreed_by|join(", ")) + "\n"' council_decision.json)

          ---

          ## ğŸ¤” Debated Issues (AIs Disagree)

          These issues need human judgment:

          $(jq -r '.debated_issues[] | "### " + .issue + "\n- ğŸ­ **Claude**: " + .claude_says + "\n- ğŸ’ **Gemini**: " + .gemini_says + "\n- ğŸ™ **Copilot**: " + .copilot_says + "\n"' council_decision.json)

          ---

          ## âœ… Must Fix Before Merge

          $(jq -r '.must_fix[] | "- [ ] " + .' council_decision.json)

          ---

          ## ğŸ’¡ Nice to Have

          $(jq -r '.nice_to_have[] | "- " + .' council_decision.json)

          ---

          ## ğŸ“Š Individual AI Reports

          <details>
          <summary>ğŸ­ Claude's Full Analysis</summary>

          $(cat reviews/claude-review/claude_review.json 2>/dev/null | jq -r '.')

          </details>

          <details>
          <summary>ğŸ’ Gemini's Full Analysis</summary>

          $(cat reviews/gemini-review/gemini_review.json 2>/dev/null | jq -r '.')

          </details>

          <details>
          <summary>ğŸ™ Copilot's Full Analysis</summary>

          $(cat reviews/copilot-review/copilot_review.json 2>/dev/null | jq -r '.')

          </details>

          ---

          _Generated by AI Council - Where Multiple AIs Debate Your Code_ ğŸ§ 
          REPORT

      - name: ğŸ’¬ Post Council Decision to PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('council_report.md', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: report
            });

      - name: âŒ Fail if Critical Issues Found
        run: |
          RISK=$(jq -r '.overall_risk' council_decision.json)
          if [ "$RISK" -gt 7 ]; then
            echo "âŒ AI Council has determined this PR is too risky (risk: $RISK/10)"
            exit 1
          fi
