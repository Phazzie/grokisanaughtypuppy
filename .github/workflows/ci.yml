name: ğŸ¤– CI/CD Pipeline

on:
  push:
    branches: ['main', 'develop', 'claude/**']
  pull_request:
    branches: ['main', 'develop']
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write
  security-events: write

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # LINTING & CODE QUALITY
  # ============================================
  lint:
    name: ğŸ” Lint & Format Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ’¾ Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            backend/node_modules
            grok-chat/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: ğŸ“¦ Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: ğŸ“¦ Install frontend dependencies
        working-directory: ./grok-chat
        run: npm ci

      - name: ğŸ” Lint backend (if script exists)
        working-directory: ./backend
        run: |
          if npm run | grep -q "lint"; then
            echo "Running backend lint..."
            npm run lint
          else
            echo "âš ï¸  No lint script in backend/package.json - skipping"
            echo "Add: \"lint\": \"eslint . --ext .js\" to package.json"
          fi
        continue-on-error: true

      - name: ğŸ” Lint frontend (if script exists)
        working-directory: ./grok-chat
        run: |
          if npm run | grep -q "lint"; then
            echo "Running frontend lint..."
            npm run lint
          else
            echo "âš ï¸  No lint script in grok-chat/package.json - skipping"
            echo "Add: \"lint\": \"ng lint\" to package.json"
          fi
        continue-on-error: true

      - name: ğŸ¨ Check code formatting with Prettier
        run: |
          if ! command -v prettier &> /dev/null; then
            npm install -g prettier
          fi
          prettier --check "**/*.{js,ts,json,md,yml}" || echo "âš ï¸  Code formatting issues found. Run 'prettier --write .' to fix."
        continue-on-error: true

      - name: ğŸ“ TypeScript type check (frontend)
        working-directory: ./grok-chat
        run: |
          if [ -f "tsconfig.json" ]; then
            npx tsc --noEmit || echo "âš ï¸  TypeScript errors found"
          fi
        continue-on-error: true

  # ============================================
  # SECURITY SCANNING
  # ============================================
  security:
    name: ğŸ”’ Security Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ” Run npm audit (Backend)
        working-directory: ./backend
        run: |
          echo "Running npm audit for backend..."
          npm audit --audit-level=moderate || echo "âš ï¸  Security vulnerabilities found in backend"
          npm audit --json > ../backend-audit.json || true
        continue-on-error: true

      - name: ğŸ” Run npm audit (Frontend)
        working-directory: ./grok-chat
        run: |
          echo "Running npm audit for frontend..."
          npm audit --audit-level=moderate || echo "âš ï¸  Security vulnerabilities found in frontend"
          npm audit --json > ../frontend-audit.json || true
        continue-on-error: true

      - name: ğŸ“¤ Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-results
          path: |
            backend-audit.json
            frontend-audit.json
          retention-days: 30
        if: always()

      - name: ğŸ›¡ï¸ Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript

      - name: ğŸ”¬ Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        continue-on-error: true

  # ============================================
  # BACKEND TESTS
  # ============================================
  backend-tests:
    name: ğŸ§ª Backend Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: ğŸ“¦ Install Dependencies
        working-directory: backend
        run: npm ci

      - name: ğŸ§ª Run Backend Tests
        working-directory: backend
        env:
          NODE_ENV: test
          XAI_API_KEY: test-key
          DATABASE_URL: postgresql://test:test@localhost:5432/test_db
        run: npm test || echo "âš ï¸  No tests configured yet"
        continue-on-error: true

      - name: ğŸ“¤ Upload backend coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage/coverage-final.json
          flags: backend
          name: backend-coverage
        if: always()
        continue-on-error: true

  # ============================================
  # FRONTEND TESTS
  # ============================================
  frontend-tests:
    name: ğŸ§ª Frontend Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: grok-chat/package-lock.json

      - name: ğŸ“¦ Install Dependencies
        working-directory: grok-chat
        run: npm ci

      - name: ğŸ§ª Run Unit Tests
        working-directory: grok-chat
        run: npm test -- --watch=false --browsers=ChromeHeadless --code-coverage
        continue-on-error: true

      - name: ğŸ“¤ Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: grok-chat/coverage/
          retention-days: 30
        if: always()

      - name: ğŸ“¤ Upload frontend coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./grok-chat/coverage/lcov.info
          flags: frontend
          name: frontend-coverage
        if: always()
        continue-on-error: true

  # ============================================
  # BUILD VERIFICATION
  # ============================================
  build-backend:
    name: ğŸ—ï¸ Build Backend
    runs-on: ubuntu-latest
    needs: [lint, backend-tests]
    if: always()

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: ğŸ“¦ Install Dependencies
        working-directory: backend
        run: npm ci --production

      - name: âœ… Verify Backend Structure
        working-directory: backend
        run: |
          echo "âœ… Backend build verification complete"
          ls -la

  build-frontend:
    name: ğŸ—ï¸ Build Frontend (Production)
    runs-on: ubuntu-latest
    needs: [lint, frontend-tests]
    if: always()

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: grok-chat/package-lock.json

      - name: ğŸ“¦ Install Dependencies
        working-directory: grok-chat
        run: npm ci

      - name: ğŸ—ï¸ Build Angular App (Production)
        working-directory: grok-chat
        run: npm run build -- --configuration production

      - name: ğŸ“Š Check Build Size
        working-directory: grok-chat
        run: |
          echo "ğŸ“¦ Build Output:"
          if [ -d dist/grok-chat/browser ]; then
            du -sh dist/grok-chat/browser
            echo "ğŸ“Š Detailed breakdown:"
            du -h dist/grok-chat/browser/*
          elif [ -d dist ]; then
            echo "âš ï¸  dist/grok-chat/browser not found, falling back to dist/"
            du -sh dist
            echo "ğŸ“Š Detailed breakdown:"
            du -h dist/*
          else
            echo "âŒ No build output directory found"
          fi

      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: grok-chat/dist/
          retention-days: 7
        if: success()

  # ============================================
  # CI SUMMARY
  # ============================================
  ci-success:
    name: âœ… CI Pipeline Complete
    runs-on: ubuntu-latest
    needs:
      - lint
      - security
      - backend-tests
      - frontend-tests
      - build-backend
      - build-frontend
    if: always()

    steps:
      - name: ğŸ‰ CI Pipeline Status
        run: |
          echo "============================================"
          echo "ğŸ¤– CI/CD Pipeline Complete!"
          echo "============================================"
          echo ""
          echo "ğŸ“Š Pipeline Summary:"
          echo "  - Linting: ${{ needs.lint.result }}"
          echo "  - Security: ${{ needs.security.result }}"
          echo "  - Backend Tests: ${{ needs.backend-tests.result }}"
          echo "  - Frontend Tests: ${{ needs.frontend-tests.result }}"
          echo "  - Backend Build: ${{ needs.build-backend.result }}"
          echo "  - Frontend Build: ${{ needs.build-frontend.result }}"
          echo ""
          echo "âœ… CI checks completed"
          echo "============================================"

      - name: âŒ Fail if critical jobs failed
        if: |
          needs.build-backend.result == 'failure' ||
          needs.build-frontend.result == 'failure'
        run: |
          echo "âŒ Critical build jobs failed!"
          exit 1
