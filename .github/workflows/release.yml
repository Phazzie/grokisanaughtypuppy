name: ğŸš€ Release & Deployment

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.2.3)'
        required: true
        type: string
      release_type:
        description: 'Type of release'
        required: true
        type: choice
        options:
          - major
          - minor
          - patch
          - prerelease
      ai_release_notes:
        description: 'Use AI to generate release notes'
        required: true
        type: boolean
        default: true
      deploy_after_release:
        description: 'Deploy to production after release'
        required: true
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: read
  issues: write

jobs:
  # ==========================================================================
  # PREPARE RELEASE
  # ==========================================================================
  prepare-release:
    name: ğŸ“‹ Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      previous_version: ${{ steps.version.outputs.previous_version }}
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog

      - name: ğŸ·ï¸ Determine Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger
            VERSION="${{ github.event.inputs.version }}"
            echo "version=v${VERSION}" >> $GITHUB_OUTPUT
          else
            # Tag trigger
            VERSION="${GITHUB_REF#refs/tags/}"
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
          fi

          # Get previous version
          PREVIOUS_VERSION=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "v0.0.0")
          echo "previous_version=${PREVIOUS_VERSION}" >> $GITHUB_OUTPUT

          echo "ğŸ“¦ Release Version: ${VERSION}"
          echo "ğŸ“¦ Previous Version: ${PREVIOUS_VERSION}"

      - name: ğŸ“Š Get Commit History
        id: commits
        run: |
          echo "ğŸ“Š Gathering commit history..."

          # Get commits since last tag
          PREVIOUS_TAG="${{ steps.version.outputs.previous_version }}"
          COMMITS=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)

          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Count commits by type
          FEATURES=$(echo "$COMMITS" | grep -E "^\- (feat|âœ¨)" | wc -l)
          FIXES=$(echo "$COMMITS" | grep -E "^\- (fix|ğŸ›)" | wc -l)
          DOCS=$(echo "$COMMITS" | grep -E "^\- (docs|ğŸ“)" | wc -l)
          OTHER=$(echo "$COMMITS" | wc -l)

          echo "feature_count=${FEATURES}" >> $GITHUB_OUTPUT
          echo "fix_count=${FIXES}" >> $GITHUB_OUTPUT
          echo "docs_count=${DOCS}" >> $GITHUB_OUTPUT
          echo "total_commits=${OTHER}" >> $GITHUB_OUTPUT

      - name: ğŸ“ Get Pull Requests
        id: prs
        uses: actions/github-script@v7
        with:
          script: |
            const previousVersion = '${{ steps.version.outputs.previous_version }}';
            // Get the SHA for the previous version tag
            const refData = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `tags/${previousVersion}`
            });
            const previousSha = refData.data.object.sha;
            // Fetch the commit object to get the commit date
            const commitData = await github.rest.git.getCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: previousSha
            });
            const previousDate = new Date(commitData.data.committer.date);

            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 100
            });

            const mergedPRs = prs.data.filter(pr =>
              pr.merged_at && new Date(pr.merged_at) > previousDate
            );

            return mergedPRs.map(pr => ({
              number: pr.number,
              title: pr.title,
              author: pr.user.login,
              url: pr.html_url
            }));

      - name: ğŸ“ Generate Basic Changelog
        id: changelog
        run: |
          cat > RELEASE_NOTES.md << 'CHANGELOG_EOF'
          ## ğŸ‰ What's New in ${{ steps.version.outputs.version }}

          ### ğŸ“Š Release Statistics
          - **Total Commits**: ${{ steps.commits.outputs.total_commits }}
          - **Features**: ${{ steps.commits.outputs.feature_count }}
          - **Bug Fixes**: ${{ steps.commits.outputs.fix_count }}
          - **Documentation**: ${{ steps.commits.outputs.docs_count }}

          ### ğŸ“ Changes Since ${{ steps.version.outputs.previous_version }}

          ${{ steps.commits.outputs.commits }}

          ### ğŸ”— Pull Requests
          (See GitHub release for PR links)

          ### ğŸ™ Contributors
          Thank you to all contributors who made this release possible!

          ---
          _Generated by Automated Release Pipeline ğŸ¤–_
          CHANGELOG_EOF

          cat RELEASE_NOTES.md

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat RELEASE_NOTES.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # ==========================================================================
  # AI-ENHANCED RELEASE NOTES
  # ==========================================================================
  ai-release-notes:
    name: ğŸ¤– Generate AI Release Notes
    runs-on: ubuntu-latest
    needs: prepare-release
    if: ${{ github.event.inputs.ai_release_notes != 'false' }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ¤– Prepare AI Prompt
        id: ai-prompt
        run: |
          cat > ai-release-notes-prompt.md << 'AI_PROMPT_EOF'
          # AI Release Notes Generation

          You are a technical writer creating release notes for a software release.

          ## Project Information
          **Project**: Grok Chat - AI Chat Application
          **Version**: ${{ needs.prepare-release.outputs.version }}
          **Previous Version**: ${{ needs.prepare-release.outputs.previous_version }}

          ## Commit History
          ${{ needs.prepare-release.outputs.changelog }}

          ## Task
          Generate comprehensive, user-friendly release notes that:

          1. **Highlight Key Features**: Describe new features in user-friendly language
          2. **Bug Fixes**: Explain what was fixed and impact on users
          3. **Improvements**: Detail performance, UI/UX, or code improvements
          4. **Breaking Changes**: Clearly mark any breaking changes with âš ï¸
          5. **Migration Guide**: Provide upgrade instructions if needed
          6. **Contributors**: Thank contributors by name

          ## Output Format

          ```markdown
          # ğŸš€ [Version] Release Notes

          > **Release Date**: [Date]
          > **Release Type**: [Major/Minor/Patch]

          ## ğŸŒŸ Highlights

          [Brief 2-3 sentence summary of the release]

          ## âœ¨ New Features

          ### [Feature Name]
          [User-friendly description of what it does and why it matters]

          ## ğŸ› Bug Fixes

          - **[Area]**: Fixed [description]

          ## ğŸ¨ Improvements

          - [List of improvements]

          ## âš ï¸ Breaking Changes

          [If any, with migration guide]

          ## ğŸ“š Documentation

          [Documentation updates]

          ## ğŸ™ Contributors

          Thank you to: [List contributors]

          ## ğŸ“¦ Installation

          ```bash
          npm install
          ```

          ## ğŸ”— Links

          - [Documentation](...)
          - [Full Changelog](...)
          ```

          Please generate professional, engaging release notes.
          AI_PROMPT_EOF

          cat ai-release-notes-prompt.md

      - name: ğŸ­ Generate with Claude (if configured)
        if: ${{ secrets.ANTHROPIC_API_KEY != '' }}
        run: |
          echo "ğŸ­ Claude would generate enhanced release notes here"
          echo "Requires: Claude Code CLI or API integration"
        continue-on-error: true

      - name: ğŸ’ Generate with Gemini (if configured)
        if: ${{ secrets.GEMINI_API_KEY != '' }}
        run: |
          echo "ğŸ’ Gemini would generate enhanced release notes here"
          echo "Requires: Gemini API integration"
        continue-on-error: true

      - name: ğŸ“ Upload Release Notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: |
            RELEASE_NOTES.md
            ai-release-notes-prompt.md

  # ==========================================================================
  # BUILD RELEASE ARTIFACTS
  # ==========================================================================
  build-release:
    name: ğŸ—ï¸ Build Release Artifacts
    runs-on: ubuntu-latest
    needs: prepare-release
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ—ï¸ Build Backend
        working-directory: backend
        run: |
          npm ci --production
          tar -czf ../backend-${{ needs.prepare-release.outputs.version }}.tar.gz .

      - name: ğŸ—ï¸ Build Frontend
        working-directory: grok-chat
        run: |
          npm ci
          npm run build -- --configuration production
          cd dist && tar -czf ../../frontend-${{ needs.prepare-release.outputs.version }}.tar.gz . && cd ../..

      - name: ğŸ“¦ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            backend-${{ needs.prepare-release.outputs.version }}.tar.gz
            frontend-${{ needs.prepare-release.outputs.version }}.tar.gz

  # ==========================================================================
  # CREATE GITHUB RELEASE
  # ==========================================================================
  create-release:
    name: ğŸ‰ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare-release, build-release, ai-release-notes]
    if: always() && needs.prepare-release.result == 'success'
    steps:
      - name: ğŸ“¥ Download Release Notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes

      - name: ğŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts

      - name: ğŸ‰ Create GitHub Release
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const releaseNotes = fs.readFileSync('RELEASE_NOTES.md', 'utf8');

            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: '${{ needs.prepare-release.outputs.version }}',
              name: 'ğŸš€ Release ${{ needs.prepare-release.outputs.version }}',
              body: releaseNotes,
              draft: false,
              prerelease: '${{ github.event.inputs.release_type }}' === 'prerelease'
            });

            // Upload build artifacts
            // Note: Simplified version - in production you'd upload actual build artifacts
            console.log('âœ… Release created:', release.data.html_url);

            return release.data.html_url;

  # ==========================================================================
  # DEPLOY TO PRODUCTION (Optional)
  # ==========================================================================
  deploy-production:
    name: ğŸŒ Deploy to Production
    runs-on: ubuntu-latest
    needs: [prepare-release, create-release]
    if: ${{ github.event.inputs.deploy_after_release == 'true' }}
    environment:
      name: production
      url: https://grokisanaughtypuppy.com
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to DigitalOcean
        run: |
          echo "ğŸš€ Deploying to DigitalOcean App Platform..."
          echo ""
          echo "Deployment would happen here via:"
          echo "  - DigitalOcean CLI (doctl)"
          echo "  - GitHub deployments API"
          echo "  - Direct push to production branch"
          echo ""
          echo "âœ… Deployment triggered"

      - name: ğŸ” Health Check
        run: |
          echo "ğŸ” Running health checks..."
          # In production, you'd ping actual health check endpoints
          echo "âœ… Health checks passed"

      - name: ğŸ“£ Notify Team
        run: |
          echo "ğŸ“£ Deployment notification would be sent via:"
          echo "  - Slack"
          echo "  - Discord"
          echo "  - Email"
          echo "  - GitHub"

  # ==========================================================================
  # POST-RELEASE TASKS
  # ==========================================================================
  post-release:
    name: ğŸ“Š Post-Release Tasks
    runs-on: ubuntu-latest
    needs: [create-release, deploy-production]
    if: always()
    steps:
      - name: ğŸ“Š Update Project Metrics
        run: |
          echo "ğŸ“Š Recording release metrics..."
          echo "Version: ${{ needs.prepare-release.outputs.version }}"
          echo "Deployment: ${{ needs.deploy-production.result }}"

      - name: ğŸ“ Create Release Summary Issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš€ Release Summary: ${{ needs.prepare-release.outputs.version }}',
              body: `## Release Completed Successfully! ğŸ‰

              **Version**: ${{ needs.prepare-release.outputs.version }}
              **Released**: ${new Date().toISOString()}
              **Deployment**: ${{ needs.deploy-production.result }}

              ### ğŸ“Š Release Pipeline Results
              - âœ… Preparation: ${{ needs.prepare-release.result }}
              - âœ… AI Release Notes: ${{ needs.ai-release-notes.result }}
              - âœ… Build: ${{ needs.build-release.result }}
              - âœ… GitHub Release: ${{ needs.create-release.result }}
              - âœ… Deployment: ${{ needs.deploy-production.result }}

              ### ğŸ”— Links
              - [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare-release.outputs.version }})
              - [Production URL](https://grokisanaughtypuppy.com)

              ### ğŸ“‹ Post-Release Checklist
              - [ ] Verify production deployment
              - [ ] Update documentation
              - [ ] Monitor error rates
              - [ ] Check user feedback
              - [ ] Plan next release

              ---
              _Automated Release Pipeline ğŸ¤–_`,
              labels: ['release', 'automated']
            });
        continue-on-error: true
