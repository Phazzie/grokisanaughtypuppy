name: ðŸ”® Predictive CI - Smart Testing

# Analyzes changes to predict risk and run appropriate tests
# Free tier using Gemini

on:
  push:
    branches: ['main', 'develop', 'claude/**']
  pull_request:
    branches: ['main', 'develop']
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  analyze-risk:
    name: ðŸ“Š Analyze Change Risk
    runs-on: ubuntu-latest
    outputs:
      risk_score: ${{ steps.risk.outputs.score }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 100

      - name: Get Changed Files
        id: files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} > changed_files.txt
          else
            git diff --name-only HEAD~1 HEAD > changed_files.txt || git ls-files > changed_files.txt
          fi

          echo "Files changed:"
          cat changed_files.txt

          # Count critical files (backend, database, security)
          CRITICAL=$(grep -E '(auth|security|db\.js|server\.js|migration)' changed_files.txt | wc -l || echo "0")
          echo "critical_files=$CRITICAL" >> $GITHUB_OUTPUT

      - name: Analyze with Gemini
        if: ${{ secrets.GEMINI_API_KEY != '' }}
        uses: google-github-actions/run-gemini-cli@v1
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            Analyze the risk of these code changes:

            Changed files: $(cat changed_files.txt)
            Critical files count: ${{ steps.files.outputs.critical_files }}

            Provide a risk score from 1-10 and explain:
            - What could break
            - What tests should be run
            - Any performance concerns

      - name: Calculate Risk Score
        id: risk
        run: |
          CRITICAL=${{ steps.files.outputs.critical_files }}
          if [ "$CRITICAL" -gt 5 ]; then
            echo "score=high" >> $GITHUB_OUTPUT
          elif [ "$CRITICAL" -gt 2 ]; then
            echo "score=medium" >> $GITHUB_OUTPUT
          else
            echo "score=low" >> $GITHUB_OUTPUT
          fi
          echo "Risk level: $(cat $GITHUB_OUTPUT)"

  run-tests:
    name: ðŸ§ª Run Tests Based on Risk
    runs-on: ubuntu-latest
    needs: analyze-risk
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            grok-chat/package-lock.json

      - name: Install Dependencies
        run: |
          cd backend && npm ci
          cd ../grok-chat && npm ci

      - name: Run Tests (Risk-Based)
        run: |
          RISK="${{ needs.analyze-risk.outputs.risk_score }}"
          echo "Risk level: $RISK"

          if [ "$RISK" == "high" ]; then
            echo "ðŸ”´ HIGH RISK - Running full test suite"
            cd grok-chat && npm test -- --watch=false --browsers=ChromeHeadless --code-coverage || echo "Tests not fully configured"
          elif [ "$RISK" == "medium" ]; then
            echo "ðŸŸ¡ MEDIUM RISK - Running targeted tests"
            cd grok-chat && npm test -- --watch=false --browsers=ChromeHeadless || echo "Tests not fully configured"
          else
            echo "ðŸŸ¢ LOW RISK - Running smoke tests only"
            cd grok-chat && npm run build
          fi
